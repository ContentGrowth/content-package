---
/**
 * ContentList Component
 * Displays a list of articles with pagination
 */
import type { ContentListProps } from '../types/index.js';
import { ContentGrowthClient } from '../core/client.js';
import FeaturedCard from './FeaturedCard.astro';
import ContentCard from './ContentCard.astro';

interface Props extends ContentListProps {}

const {
  apiKey,
  baseUrl,
  layout = 'cards',
  displayMode = 'comfortable',
  displayAs = 'default',
  theme = 'light',
  pageSize = 12,
  tags = [],
  category,
  showPagination = true,
  linkPattern = '/articles/{uuid}',
  showTags = false,
  showAiSummary = true,
  summaryMaxLength,
  linkTarget,
  class: className = '',
  featuredCardLayout,
  showCategory = true
} = Astro.props;

// Get current page from URL
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get('page') || '1', 10);

// Fetch articles
const client = new ContentGrowthClient({ apiKey, baseUrl });

// Process tags
let processedTags: string[] | undefined;
if (tags) {
  if (Array.isArray(tags)) {
    processedTags = tags;
  } else {
    processedTags = tags.split(',').map(t => t.trim()).filter(Boolean);
  }
}

const options = {
  page: currentPage,
  limit: pageSize,
  tags: processedTags,
  category: category
};
const result = await client.listArticles(options);
const articles = result.articles;
const pagination = result.pagination;

// Build pagination URLs
function buildPageUrl(page: number): string {
  const newUrl = new URL(url);
  newUrl.searchParams.set('page', page.toString());
  return newUrl.pathname + newUrl.search;
}

// Truncate summary text
function truncateSummary(text: string | null, maxLength?: number): string {
  if (!text) return '';
  if (!maxLength || text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}

// Check if we're in featured-cards mode
const isFeaturedCardsMode = displayAs === 'featured-cards';
---

<div 
  class={`cg-content-list cg-layout-${layout} cg-display-${displayMode} cg-theme-${theme} ${isFeaturedCardsMode ? 'cg-featured-cards-list' : ''} ${className}`}
  data-cg-widget="list"
>
  {articles.length === 0 ? (
    <div class="cg-empty-state">
      <p>No articles found.</p>
    </div>
  ) : (
    <>
      <div class={`cg-articles-grid ${isFeaturedCardsMode ? (layout === 'rows' ? 'cg-featured-cards-list' : 'cg-featured-cards-grid') : (layout === 'cards' ? 'cg-grid' : 'cg-list')}`}>
        {articles.map((article) => {
          // Build link target from pattern
          const articleTarget = linkTarget
            ? linkTarget
                .replace('{uuid}', article.uuid)
                .replace('{id}', article.uuid)
            : undefined;

          // Featured Cards Mode - Use FeaturedCard component
          if (isFeaturedCardsMode) {
            return (
              <FeaturedCard
                article={article}
                linkPattern={linkPattern}
                linkTarget={articleTarget}
                showCategory={showCategory}
                layout={featuredCardLayout}
              />
            );
          }

          // Default Card Mode - Use ContentCard component
          return (
            <ContentCard
              article={article}
              linkPattern={linkPattern}
              linkTarget={articleTarget}
              showSummary={showAiSummary}
              summaryMaxLength={summaryMaxLength}
              showTags={showTags}
              showCategory={showCategory}
            />
          );
        })}
      </div>

      {showPagination && pagination.totalPages > 1 && (
        <nav class="cg-pagination" aria-label="Article pagination">
          <div class="cg-pagination-info">
            Page {pagination.page} of {pagination.totalPages}
          </div>
          
          <div class="cg-pagination-controls">
            {pagination.hasPrev && (
              <a 
                href={buildPageUrl(pagination.page - 1)} 
                class="cg-pagination-btn cg-pagination-prev"
                aria-label="Previous page"
              >
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M12 16L6 10L12 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Previous
              </a>
            )}
            
            {pagination.hasNext && (
              <a 
                href={buildPageUrl(pagination.page + 1)} 
                class="cg-pagination-btn cg-pagination-next"
                aria-label="Next page"
              >
                Next
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M8 4L14 10L8 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </a>
            )}
          </div>
        </nav>
      )}
    </>
  )}
</div>
