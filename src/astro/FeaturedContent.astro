---
import { marked } from 'marked';
import { ContentGrowthClient } from '../core/client';
import type { FeaturedContentProps } from '../types';

type Props = FeaturedContentProps & { class?: string };

const {
  apiKey,
  baseUrl,
  tags = [],
  category,
  excludeTags = [],
  showAiSummary = true,
  showCategory = true,
  showTags = true,
  class: className = ''
} = Astro.props;

// Fetch featured article
const client = new ContentGrowthClient({ apiKey, baseUrl });
let article = null;
let error = null;

try {
  article = await client.getFeaturedArticle({
    tags,
    category,
    excludeTags
  });
} catch (e) {
  // If 404, article remains null.
  console.error('Failed to fetch featured article:', e);
  error = e instanceof Error ? e.message : 'Failed to load featured article';
}

// Render markdown to HTML
const contentHtml = article ? marked(article.content) : '';
---

{article ? (
  <div class={`cg-content-viewer ${className}`} data-cg-widget="post">
    <article>
      <header class="cg-content-header">
        {showCategory && article.category && (
          <div class="cg-content-category">
            <span class="cg-category-badge">{article.category}</span>
          </div>
        )}
        
        <h1 class="cg-content-title">{article.title}</h1>
        
        {showAiSummary && article.summary && (
          <div class="cg-ai-summary">
            <div class="cg-ai-summary-header">
              <svg class="cg-ai-summary-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              <span class="cg-ai-summary-label">AI Generated Summary</span>
            </div>
            <p class="cg-ai-summary-text">{article.summary}</p>
          </div>
        )}
        
        <div class="cg-content-meta">
          <span class="cg-info-author">{article.authorName}</span>
          <span class="cg-info-separator">•</span>
          <time class="cg-info-date" datetime={new Date(article.publishedAt * 1000).toISOString()}>
            {new Date(article.publishedAt * 1000).toLocaleDateString()}
          </time>
          <span class="cg-info-separator">•</span>
          <span class="cg-info-reading-time">{Math.ceil(article.wordCount / 200)} min read</span>
        </div>
        
        {showTags && article.tags && article.tags.length > 0 && (
          <div class="cg-content-tags">
            {article.tags.map((tag: string) => (
              <span class="cg-tag">{tag}</span>
            ))}
          </div>
        )}
      </header>

      <div class="cg-content-body" set:html={contentHtml} />
    </article>
  </div>
) : (
  error ? (
     <div class={`cg-widget cg-error ${className}`}>
      {error}
    </div>
  ) : null
)}
