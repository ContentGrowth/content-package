---
import { marked } from 'marked';
import { ContentGrowthClient } from '../core/client';
import { formatDate, calculateReadingTime } from '../core/utils';
import type { Article, ArticleWithContent } from '../types';

interface ContentCardProps {
  /**
   * Pre-loaded article data (bypasses API fetch)
   */
  article?: Article | ArticleWithContent;

  /**
   * Load specific article by slug
   */
  slug?: string;

  /**
   * Load specific article by UUID
   */
  uuid?: string;

  /**
   * API key (required if fetching article)
   */
  apiKey?: string;

  /**
   * API base URL
   */
  baseUrl?: string;

  /**
   * URL pattern for the article link
   * Supports placeholders: {uuid}, {slug}, {category}
   * @default '/articles/{slug}'
   */
  linkPattern?: string;

  /**
   * Link target attribute
   */
  linkTarget?: string;

  /**
   * Show article summary
   * @default true
   */
  showSummary?: boolean;

  /**
   * Maximum length of summary text
   */
  summaryMaxLength?: number;

  /**
   * Show article tags
   * @default false
   */
  showTags?: boolean;

  /**
   * Show article category
   * @default true
   */
  showCategory?: boolean;
}

type Props = ContentCardProps & { class?: string };

const {
  apiKey,
  baseUrl,
  article: providedArticle,
  slug,
  uuid,
  linkPattern = '/articles/{slug}',
  linkTarget,
  showSummary = true,
  summaryMaxLength,
  showTags = false,
  showCategory = true,
  class: className = ''
} = Astro.props;

// Determine article source
let article: Article | ArticleWithContent | null = null;
let error: string | null = null;

if (providedArticle) {
  // Mode 1: Article provided directly
  article = providedArticle;
} else if (apiKey) {
  // Need to fetch article from API
  const client = new ContentGrowthClient({ apiKey, baseUrl });
  
  try {
    if (uuid) {
      // Mode 2: Load by UUID
      article = await client.getArticle(uuid);
    } else if (slug) {
      // Mode 3: Load by slug
      article = await client.getArticleBySlug(slug);
    }
  } catch (e) {
    console.error('Failed to fetch article:', e);
    error = e instanceof Error ? e.message : 'Failed to load article';
  }
}

// Generate article URL
const getArticleUrl = (article: any) => {
  if (!article) return '#';
  return linkPattern
    .replace('{uuid}', article.uuid || '')
    .replace('{slug}', article.slug || article.uuid || '')
    .replace('{category}', article.category || 'uncategorized');
};

// Truncate summary text
const truncateSummary = (text: string | null, maxLength?: number): string => {
  if (!text) return '';
  if (!maxLength || text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
};
---

{article ? (
  <article class={`cg-article-card ${className}`}>
    <a href={getArticleUrl(article)} target={linkTarget} class="cg-card-link">
      <div class="cg-card-content">
        {showCategory && article.category && (
          <div class="cg-card-category">
            <span class="cg-category-badge">{article.category}</span>
          </div>
        )}
        
        <h2 class="cg-card-title">{article.title}</h2>
        
        {showSummary && article.summary && (
          <p class="cg-card-summary">{truncateSummary(article.summary, summaryMaxLength)}</p>
        )}
        
        <div class="cg-card-meta">
          <span class="cg-meta-author">{article.authorName}</span>
          <span class="cg-meta-separator">•</span>
          <time class="cg-meta-date" datetime={new Date(article.publishedAt * 1000).toISOString()}>
            {formatDate(article.publishedAt)}
          </time>
          <span class="cg-meta-separator">•</span>
          <span class="cg-meta-reading-time">{calculateReadingTime(article.wordCount)}</span>
        </div>
        
        {showTags && article.tags && article.tags.length > 0 && (
          <div class="cg-card-tags">
            {article.tags.map((tag) => (
              <span class="cg-tag">{tag}</span>
            ))}
          </div>
        )}
      </div>
    </a>
  </article>
) : (
  error ? (
    <div class={`cg-widget cg-error ${className}`}>
      {error}
    </div>
  ) : null
)}
