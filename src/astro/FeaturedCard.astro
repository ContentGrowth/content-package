---
import { ContentGrowthClient } from '../core/client';
import { renderInlineMarkdownJS } from '../core/inline-markdown';
import type { FeaturedContentProps, Article, ArticleWithContent } from '../types';

interface FeaturedCardProps extends Omit<FeaturedContentProps, 'showBackButton' | 'backUrl'> {
  /**
   * Pre-loaded article data (bypasses API fetch - used by ContentList)
   */
  article?: Article | ArticleWithContent;

  /**
   * Load specific article by slug (bypasses category/tags search)
   */
  slug?: string;

  /**
   * Load specific article by UUID (bypasses category/tags search)
   */
  uuid?: string;

  /**
   * URL pattern for the article link
   * Supports placeholders: {uuid}, {slug}, {category}
   * @default '/articles/{slug}'
   */
  linkPattern?: string;
  
  /**
   * Show reading time
   * @default false
   */
  showReadingTime?: boolean;

  /**
   * Show author
   * @default false
   */
  showAuthor?: boolean;

  /**
   * Text for the Call to Action link
   * @default "Read full story"
   */
  ctaText?: string;

  /**
   * Layout override (defaults to article settings)
   */
  layout?: 'vertical' | 'horizontal';

  /**
   * Border style
   * @default 'none'
   */
  borderStyle?: 'none' | 'line' | 'dashed';

  /**
   * Border color (CSS color value)
   * @default '#e5e7eb'
   */
  borderColor?: string;

  /**
   * Card background color (CSS color value, 'none' for transparent)
   * @default 'none'
   */
  cardBackground?: string;

  /**
   * Background color for list/quote section (the items area)
   * @default '#f3f4f6'
   */
  itemsBackground?: string;

  /**
   * Link target attribute
   * @default undefined (same tab)
   */
  linkTarget?: string;

  /**
   * Custom padding for the card content
   * @example "20px" or "0"
   */
  padding?: string;

  /**
   * Override category display text
   */
  categoryLabel?: string;
}

type Props = FeaturedCardProps & { class?: string };

const {
  apiKey,
  baseUrl,
  article: providedArticle,
  slug,
  uuid,
  tags = [],
  category,
  excludeTags = [],
  showCategory = true,
  showReadingTime = false,
  showAuthor = false,
  ctaText: propCtaText,
  linkPattern = '/articles/{slug}',
  linkTarget,
  layout: propLayout,
  borderStyle = 'none',
  borderColor = '#e5e7eb',
  cardBackground = 'none',
  itemsBackground = '#f3f4f6',
  padding,
  categoryLabel,
  class: className = ''
} = Astro.props;

// Determine article source
let article: Article | ArticleWithContent | null = null;
let error: string | null = null;

if (providedArticle) {
  // Mode 1: Article provided directly (from ContentList)
  article = providedArticle;
} else if (apiKey) {
  // Need to fetch article from API
  const client = new ContentGrowthClient({ apiKey, baseUrl });
  
  try {
    if (uuid) {
      // Mode 2: Load by UUID
      article = await client.getArticle(uuid, { excludeTags });
    } else if (slug) {
      // Mode 3: Load by slug
      article = await client.getArticleBySlug(slug, { excludeTags });
    } else {
      // Mode 4: Find featured article by category/tags (original behavior)
      article = await client.getFeaturedArticle({
        tags,
        category,
        excludeTags
      });
    }
  } catch (e) {
    console.error('Failed to fetch article:', e);
    error = e instanceof Error ? e.message : 'Failed to load article';
  }
}

// Generate article URL
const getArticleUrl = (article: any) => {
  if (!article) return '#';
  return linkPattern
    .replace('{uuid}', article.uuid || '')
    .replace('{slug}', article.slug || article.uuid || '')
    .replace('{category}', article.category || 'uncategorized');
};

// Parse featured summary - supports both JSON (new) and plain text (legacy)
// Parse featured summary - supports both JSON (new) and plain text (legacy)
interface SummaryData {
  type: 'classic' | 'list' | 'steps' | 'quote' | 'legacy';
  title?: string;
  text?: string;
  intro?: string;
  items?: Array<{ title: string; description: string }>;
  quote?: string;
  highlight?: string;
}

const parseSummary = (article: any): SummaryData | null => {
  const summaryText = article.featuredSummary || article.summary;
  if (!summaryText) return null;
  
  // Try to parse as JSON
  try {
    const parsed = JSON.parse(summaryText);
    if (parsed.type) {
      return parsed as SummaryData;
    }
  } catch (e) {
    // Not JSON, treat as legacy markdown/plain text
  }
  
  // Legacy fallback - render as plain text
  return {
    type: 'legacy',
    text: summaryText
  };
};

const summaryData = article ? parseSummary(article) : null;
const displayTitle = summaryData?.title || (article ? (article as any).title : '');

const layout = propLayout || (article as any)?.featuredSummaryLayout || 'vertical';
const layoutClass = layout !== 'vertical' ? `cg-layout-${layout}` : '';
const borderClass = borderStyle !== 'none' ? `cg-border-${borderStyle}` : '';

// Use ctaText from prop, or from article data, or fallback to default
const ctaText = propCtaText || (article as any)?.featuredCtaText || 'Read full story';

// Custom CSS properties for styling
const customStyles = [
  borderColor !== '#e5e7eb' ? `--cg-card-border-color: ${borderColor}` : '',
  cardBackground !== 'none' ? `--cg-card-bg: ${cardBackground}` : '',
  itemsBackground !== '#f3f4f6' ? `--cg-items-bg: ${itemsBackground}` : '',
  padding ? `--cg-card-padding: ${padding}` : '',
].filter(Boolean).join('; ');
---

{article ? (
  <a 
    href={getArticleUrl(article)} 
    class={`cg-widget cg-featured-card ${className} ${layoutClass} ${borderClass}`}
    style={customStyles || undefined}
    data-cg-widget="featured-card"
    target={linkTarget}
    rel={linkTarget === '_blank' ? 'noopener noreferrer' : undefined}
  >
    <article class="cg-featured-card-inner">
      <div class="cg-card-primary">
        {/* Header with category badge */}
        {showCategory && (categoryLabel || (article as any).categoryLabel || article.category) && (
          <div class="cg-card-header">
            <span class="cg-category-badge">{categoryLabel || (article as any).categoryLabel || article.category}</span>
          </div>
        )}
        
        {/* Title */}
        <h3 class="cg-card-title">{displayTitle}</h3>
        
        {/* Featured Summary - Intro / Text Part */}
        {summaryData && (
          <div class="cg-featured-card-summary">
            {/* Intro for structured types */}
            {(summaryData.type === 'list' || summaryData.type === 'steps' || summaryData.type === 'quote') && summaryData.intro && (
              <p set:html={renderInlineMarkdownJS(summaryData.intro)} />
            )}

            {/* Classic type - just text */}
            {summaryData.type === 'classic' && (
              <p set:html={renderInlineMarkdownJS(summaryData.text || '')} />
            )}
            
            {/* Legacy markdown - render as plain text */}
            {summaryData.type === 'legacy' && (
              <p>{summaryData.text}</p>
            )}
          </div>
        )}
        
        {/* Footer with meta info */}
        {(showAuthor || showReadingTime) && (
          <div class="cg-featured-card-footer">
            {showAuthor && <span class="cg-featured-card-author">{article.authorName}</span>}
            
            {showAuthor && showReadingTime && (
              <span class="cg-featured-card-separator">â€¢</span>
            )}
            
            {showReadingTime && (
              <span class="cg-featured-card-reading-time">
                {Math.ceil(article.wordCount / 200)} min read
              </span>
            )}
          </div>
        )}
        
        {/* Read more indicator */}
      </div>

      {/* Right Panel - Structured Visual Items (List/Quote) */}
      {summaryData && (summaryData.type === 'list' || summaryData.type === 'steps' || summaryData.type === 'quote') && (
        <div class="cg-card-secondary">
          {(summaryData.type === 'list' || summaryData.type === 'steps') && (
            <ul class="cg-summary-items">
              {summaryData.items?.map((item, index) => (
                <li>
                  <span class="cg-item-number">{index + 1}</span>
                  <div class="cg-item-content">
                    <strong class="cg-item-title" set:html={renderInlineMarkdownJS(item.title)} />
                    <span class="cg-item-description" set:html={renderInlineMarkdownJS(item.description)} />
                  </div>
                </li>
              ))}
            </ul>
          )}
          
          {summaryData.type === 'quote' && (
            <blockquote set:html={renderInlineMarkdownJS(summaryData.quote || '')} />
          )}
        </div>
      )}

      {/* Read more indicator - Now at bottom */}
      <div class="cg-featured-card-cta">
        <span>{ctaText}</span>
        <svg class="cg-featured-card-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </article>
  </a>
) : (
  error ? (
    <div class={`cg-widget cg-error ${className}`}>
      {error}
    </div>
  ) : null
)}
